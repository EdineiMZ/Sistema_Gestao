<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
        <%= pageTitle ? `${pageTitle} • ` : '' %><%= appName || 'Sistema de Gestão' %>
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet"
    />
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
        crossorigin="anonymous"
    />
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    />
    <link rel="stylesheet" href="/css/style.css" />
</head>

<body class="theme-light" data-theme="light">

<div id="appLoader" class="app-loader d-flex align-items-center justify-content-center">
    <div class="text-center">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-3 text-white-50 small">Carregando experiência personalizada...</p>
    </div>
</div>

<div id="appShell" class="app-shell app-body theme-light" data-theme="light">
<nav class="navbar navbar-expand-lg navbar-dark bg-gradient-primary shadow-sm sticky-top">
    <div class="container-lg">
        <a class="navbar-brand fw-semibold d-flex align-items-center" href="/">
            <i class="bi bi-speedometer2 me-2"></i>
            <span><%= appName || 'Sistema de Gestão' %></span>
        </a>
        <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Alternar navegação"
        >
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
                <% if (!user) { %>
                    <li class="nav-item">
                        <a class="nav-link" href="/#solucoes">Soluções</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#seguranca">Segurança</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/#recursos">Recursos</a>
                    </li>
                    <li class="nav-item ms-lg-3">
                        <a class="btn btn-outline-light nav-cta" href="/login">
                            <i class="bi bi-box-arrow-in-right me-2"></i>
                            Entrar
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-light nav-cta" href="/register">
                            <i class="bi bi-person-plus me-2"></i>
                            Criar conta
                        </a>
                    </li>
                <% } else { %>
                    <li class="nav-item dropdown">
                        <a
                            class="nav-link dropdown-toggle d-flex align-items-center"
                            href="#"
                            id="userMenu"
                            role="button"
                            data-bs-toggle="dropdown"
                            aria-expanded="false"
                        >
                            <span class="avatar avatar-sm me-2">
                                <% if (user.profileImage) { %>
                                    <img
                                        src="data:image/png;base64,<%= user.profileImage.toString('base64') %>"
                                        alt="Avatar"
                                        class="rounded-circle"
                                        width="36"
                                        height="36"
                                    />
                                <% } else { %>
                                    <span class="avatar-initials"><%= user.name ? user.name.charAt(0).toUpperCase() : 'U' %></span>
                                <% } %>
                            </span>
                            <div class="d-flex flex-column text-start">
                                <span class="fw-semibold small"><%= user.name %></span>
                                <small class="text-white-50">
                                    <%= roleLabels && user.role ? roleLabels[user.role] || '' : '' %>
                                </small>
                            </div>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow">
                            <li><span class="dropdown-item-text text-muted">Bem-vindo(a)!</span></li>
                            <li><hr class="dropdown-divider" /></li>
                            <li>
                                <a class="dropdown-item" href="/users/preferences">
                                    <i class="bi bi-sliders me-2"></i>Preferências de notificações
                                </a>
                            </li>
                            <li><hr class="dropdown-divider" /></li>
                            <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-left me-2"></i>Sair</a></li>
                        </ul>
                    </li>

                    <% if (userRoleLevel >= 0) { %>
                        <li class="nav-item">
                            <a class="nav-link" href="/pages/sobre">Sobre</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/pages/contact">Contato</a>
                        </li>
                    <% } %>

                    <% if (userRoleLevel >= managerLevel) { %>
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">
                                <i class="bi bi-graph-up-arrow me-1"></i>Painel
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/appointments">Agendamentos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/procedures">Procedimentos</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/rooms">Salas</a>
                        </li>
                    <% } %>

                    <% if (userRoleLevel >= adminLevel) { %>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin">
                                <i class="bi bi-shield-check me-1"></i>Administração
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/users/manage">Usuários</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/finance">Financeiro</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/notifications">Notificações</a>
                        </li>
                    <% } %>
                <% } %>
                <% if (user && Array.isArray(notifications) && notifications.length) { %>
                    <li class="nav-item ms-lg-2 mt-3 mt-lg-0">
                        <a
                            class="nav-link position-relative nav-notification px-2"
                            href="/notifications"
                            aria-label="Visualizar notificações disponíveis"
                        >
                            <i class="bi bi-bell-fill"></i>
                            <span
                                class="notification-badge badge rounded-pill bg-danger-subtle text-danger fw-semibold shadow-sm position-absolute top-0 start-100 translate-middle"
                                data-testid="notification-badge"
                                aria-hidden="true"
                            >
                                <%= notifications.length > 9 ? '9+' : notifications.length %>
                            </span>
                            <span class="visually-hidden">
                                Você possui <%= notifications.length %> notificações ativas
                            </span>
                        </a>
                    </li>
                <% } %>
                <li class="nav-item ms-lg-3 mt-3 mt-lg-0">
                    <button
                        id="themeToggle"
                        class="theme-toggle"
                        type="button"
                        aria-pressed="false"
                        aria-label="Alternar para tema escuro"
                    >
                        <i class="bi bi-moon-stars theme-toggle-icon" id="themeToggleIcon" aria-hidden="true"></i>
                        <span class="theme-toggle-label d-none d-lg-inline" data-theme-label>Modo escuro</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<main class="container-xl page-container py-5">
