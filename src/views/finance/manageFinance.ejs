<%- include('../partials/header') %>

<%
    const activeFilters = filters || {};
    const queryString = new URLSearchParams(activeFilters).toString();
    const pdfUrl = `/finance/export/pdf${queryString ? `?${queryString}` : ''}`;
    const excelUrl = `/finance/export/excel${queryString ? `?${queryString}` : ''}`;
    const totals = financeTotals || { payable: 0, receivable: 0, net: 0, overdue: 0, pending: 0, paid: 0 };
    const netValue = Number(parseFloat(totals.net)) || 0;
    const netPositive = netValue >= 0;
    const summaryStatus = statusSummary || {};
    const monthly = monthlySummary || [];
    const formatMoney = (value) => {
        const parsed = typeof value === 'number' ? value : parseFloat(value);
        const normalized = Number.isFinite(parsed) ? parsed : 0;
        return normalized.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    };
%>

<div class="row g-4">
    <div class="col-12">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <div>
                <h2 class="h3 mb-1">Gerenciar Finanças</h2>
                <p class="text-muted mb-0">Visão consolidada do fluxo financeiro — <%= periodLabel || 'Todo o período' %></p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-outline-primary d-flex align-items-center gap-2" href="<%= pdfUrl %>">
                    <i class="bi bi-file-earmark-pdf-fill"></i>
                    Exportar PDF
                </a>
                <a class="btn btn-primary d-flex align-items-center gap-2" href="<%= excelUrl %>">
                    <i class="bi bi-file-earmark-spreadsheet-fill"></i>
                    Exportar Excel
                </a>
            </div>
        </div>
    </div>

    <div class="col-12">
        <% if (success_msg) { %>
            <div class="alert alert-success shadow-sm"><%= success_msg %></div>
        <% } else if (error_msg) { %>
            <div class="alert alert-danger shadow-sm"><%= error_msg %></div>
        <% } %>
        <form method="get" class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row g-3 align-items-end">
                    <div class="col-sm-6 col-lg-3">
                        <label class="form-label" for="filterStartDate">Início do período</label>
                        <input
                            id="filterStartDate"
                            type="date"
                            name="startDate"
                            value="<%= activeFilters.startDate || '' %>"
                            class="form-control"
                        />
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <label class="form-label" for="filterEndDate">Fim do período</label>
                        <input
                            id="filterEndDate"
                            type="date"
                            name="endDate"
                            value="<%= activeFilters.endDate || '' %>"
                            class="form-control"
                        />
                    </div>
                    <div class="col-sm-6 col-lg-auto">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-funnel-fill me-1"></i>
                            Aplicar filtros
                        </button>
                    </div>
                    <div class="col-sm-6 col-lg-auto">
                        <a href="/finance" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-eraser-fill me-1"></i>
                            Limpar
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="col-12">
        <div class="row g-3">
            <div class="col-sm-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-uppercase text-muted small mb-1">Total a receber</p>
                        <h3 class="mb-2 text-success"><%= formatMoney(totals.receivable) %></h3>
                        <span class="badge bg-success-subtle text-success">Entradas</span>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-uppercase text-muted small mb-1">Total a pagar</p>
                        <h3 class="mb-2 text-danger"><%= formatMoney(totals.payable) %></h3>
                        <span class="badge bg-danger-subtle text-danger">Saídas</span>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-uppercase text-muted small mb-1">Saldo projetado</p>
                        <h3 class="mb-2 <%= netPositive ? 'text-primary' : 'text-danger' %>"><%= formatMoney(netValue) %></h3>
                        <span class="badge <%= netPositive ? 'bg-primary-subtle text-primary' : 'bg-danger-subtle text-danger' %>">
                            <%= netPositive ? 'Superávit' : 'Déficit' %>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-xl-3">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <p class="text-uppercase text-muted small mb-1">Pagamentos em atraso</p>
                        <h3 class="mb-2 text-warning"><%= formatMoney(totals.overdue) %></h3>
                        <span class="badge bg-warning-subtle text-warning">Pendências críticas</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-xl-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pb-0">
                <h5 class="card-title mb-0">Status das movimentações</h5>
            </div>
            <div class="card-body">
                <div class="ratio ratio-4x3">
                    <canvas id="financeStatusChart" aria-label="Distribuição por status" role="img"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-12 col-xl-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white border-0 pb-0">
                <h5 class="card-title mb-0">Fluxo mensal</h5>
            </div>
            <div class="card-body">
                <div class="ratio ratio-4x3">
                    <canvas id="financeMonthlyChart" aria-label="Fluxo mensal" role="img"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 d-flex flex-column flex-md-row justify-content-between gap-2">
                <div>
                    <h5 class="card-title mb-0">Lançamentos cadastrados</h5>
                    <small class="text-muted">Atualize ou remova lançamentos diretamente na tabela</small>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-nowrap align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Descrição</th>
                                <th>Tipo</th>
                                <th>Valor</th>
                                <th>Vencimento</th>
                                <th>Pagamento</th>
                                <th>Status</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                        <% if (entries && entries.length) { %>
                            <% entries.forEach(entry => { %>
                                <tr>
                                    <td><%= entry.id %></td>
                                    <td><%= entry.description %></td>
                                    <td>
                                        <% if (entry.type === 'payable') { %>
                                            <span class="badge text-bg-danger">Pagar</span>
                                        <% } else { %>
                                            <span class="badge text-bg-success">Receber</span>
                                        <% } %>
                                    </td>
                                    <td><%= formatMoney(entry.value) %></td>
                                    <td><%= entry.dueDate ? new Date(entry.dueDate).toLocaleDateString('pt-BR') : '—' %></td>
                                    <td><%= entry.paymentDate ? new Date(entry.paymentDate).toLocaleDateString('pt-BR') : '—' %></td>
                                    <td>
                                        <span class="badge bg-secondary-subtle text-secondary text-capitalize"><%= entry.status %></span>
                                    </td>
                                    <td class="text-end">
                                        <div class="d-flex justify-content-end gap-2">
                                            <button
                                                type="button"
                                                class="btn btn-warning btn-sm"
                                                data-bs-toggle="modal"
                                                data-bs-target="#editFinanceModal<%= entry.id %>"
                                            >
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <form
                                                action="/finance/delete/<%= entry.id %>?_method=DELETE"
                                                method="POST"
                                            >
                                                <button class="btn btn-danger btn-sm" type="submit">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>

                                        <div
                                            class="modal fade"
                                            id="editFinanceModal<%= entry.id %>"
                                            tabindex="-1"
                                            aria-hidden="true"
                                        >
                                            <div class="modal-dialog">
                                                <form
                                                    action="/finance/update/<%= entry.id %>?_method=PUT"
                                                    method="POST"
                                                    class="modal-content"
                                                >
                                                    <div class="modal-header">
                                                        <h5 class="modal-title">Editar Lançamento #<%= entry.id %></h5>
                                                        <button
                                                            type="button"
                                                            class="btn-close"
                                                            data-bs-dismiss="modal"
                                                            aria-label="Close"
                                                        ></button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <input type="hidden" name="id" value="<%= entry.id %>" />

                                                        <div class="mb-3">
                                                            <label class="form-label">Descrição</label>
                                                            <input
                                                                type="text"
                                                                class="form-control"
                                                                name="description"
                                                                value="<%= entry.description %>"
                                                                required
                                                            />
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Tipo</label>
                                                            <select class="form-select" name="type" required>
                                                                <option value="payable" <%= entry.type === 'payable' ? 'selected' : '' %>>Pagar</option>
                                                                <option value="receivable" <%= entry.type === 'receivable' ? 'selected' : '' %>>Receber</option>
                                                            </select>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Valor (R$)</label>
                                                            <input
                                                                type="number"
                                                                step="0.01"
                                                                class="form-control"
                                                                name="value"
                                                                value="<%= entry.value %>"
                                                                required
                                                            />
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Data de Vencimento</label>
                                                            <input
                                                                type="date"
                                                                class="form-control"
                                                                name="dueDate"
                                                                value="<%= entry.dueDate %>"
                                                                required
                                                            />
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Data de Pagamento</label>
                                                            <input
                                                                type="date"
                                                                class="form-control"
                                                                name="paymentDate"
                                                                value="<%= entry.paymentDate ? entry.paymentDate : '' %>"
                                                            />
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label">Status</label>
                                                            <select class="form-select" name="status">
                                                                <option value="pending" <%= entry.status === 'pending' ? 'selected' : '' %>>Pendente</option>
                                                                <option value="paid" <%= entry.status === 'paid' ? 'selected' : '' %>>Pago</option>
                                                                <option value="overdue" <%= entry.status === 'overdue' ? 'selected' : '' %>>Atrasado</option>
                                                                <option value="cancelled" <%= entry.status === 'cancelled' ? 'selected' : '' %>>Cancelado</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button
                                                            type="button"
                                                            class="btn btn-secondary"
                                                            data-bs-dismiss="modal"
                                                        >
                                                            Cancelar
                                                        </button>
                                                        <button type="submit" class="btn btn-primary">Salvar</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            <% }) %>
                        <% } else { %>
                            <tr>
                                <td colspan="8" class="text-center text-muted py-5">
                                    Nenhum lançamento cadastrado para o período selecionado.
                                </td>
                            </tr>
                        <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0">
                <h5 class="card-title mb-0">Novo lançamento</h5>
            </div>
            <div class="card-body">
                <form action="/finance/create" method="POST" class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Descrição</label>
                        <input
                            type="text"
                            class="form-control"
                            name="description"
                            required
                        />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tipo</label>
                        <select class="form-select" name="type" required>
                            <option value="payable">Pagar</option>
                            <option value="receivable">Receber</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Valor (R$)</label>
                        <input
                            type="number"
                            step="0.01"
                            class="form-control"
                            name="value"
                            required
                        />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Vencimento</label>
                        <input
                            type="date"
                            class="form-control"
                            name="dueDate"
                            required
                        />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">
                            <i class="bi bi-plus-circle me-1"></i>
                            Criar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" integrity="sha384-JJTDALk2wjMq17oJGeUXrXe3G5UpiRaY1oWXcnO0xGS8Va1IAVZPgEzVCQcb1AHf" crossorigin="anonymous"></script>
<script>
    (() => {
        const statusData = <%- JSON.stringify(summaryStatus || {}) %>;
        const monthlyData = <%- JSON.stringify(monthly || []) %>;
        const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });

        const statusKeys = ['pending', 'paid', 'overdue', 'cancelled'];
        const statusLabels = ['Pendentes', 'Pagos', 'Em atraso', 'Cancelados'];
        const payableStatus = statusKeys.map((key) => Number.parseFloat(statusData?.payable?.[key] || 0));
        const receivableStatus = statusKeys.map((key) => Number.parseFloat(statusData?.receivable?.[key] || 0));

        const statusCanvas = document.getElementById('financeStatusChart');
        if (statusCanvas && window.Chart) {
            const chart = new Chart(statusCanvas, {
                type: 'bar',
                data: {
                    labels: statusLabels,
                    datasets: [
                        {
                            label: 'A pagar',
                            data: payableStatus,
                            backgroundColor: '#dc3545',
                            borderRadius: 6
                        },
                        {
                            label: 'A receber',
                            data: receivableStatus,
                            backgroundColor: '#198754',
                            borderRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = Number.parseFloat(context.raw || 0);
                                    return `${context.dataset.label}: ${currencyFormatter.format(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => currencyFormatter.format(value)
                            }
                        }
                    }
                }
            });
            statusCanvas.setAttribute('data-chart-instance', 'true');
        }

        const monthlyCanvas = document.getElementById('financeMonthlyChart');
        if (monthlyCanvas && window.Chart) {
            const labels = monthlyData.map((item) => {
                if (!item?.month) {
                    return '—';
                }
                const date = new Date(`${item.month}-01T00:00:00`);
                if (!Number.isFinite(date.getTime())) {
                    return item.month;
                }
                return date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
            });
            const receivableSeries = monthlyData.map((item) => Number.parseFloat(item?.receivable || 0));
            const payableSeries = monthlyData.map((item) => Number.parseFloat(item?.payable || 0));

            new Chart(monthlyCanvas, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Receitas',
                            data: receivableSeries,
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.15)',
                            tension: 0.35,
                            fill: true,
                            borderWidth: 2
                        },
                        {
                            label: 'Despesas',
                            data: payableSeries,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.12)',
                            tension: 0.35,
                            fill: true,
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = Number.parseFloat(context.raw || 0);
                                    return `${context.dataset.label}: ${currencyFormatter.format(value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => currencyFormatter.format(value)
                            }
                        }
                    }
                }
            });
        }
    })();
</script>

<%- include('../partials/footer') %>
