<%
    const intlCurrencyFormatter = new Intl.NumberFormat('pt-BR', {
        style: 'currency',
        currency: 'BRL'
    });
    const formatCurrencyFn = typeof formatCurrency === 'function'
        ? formatCurrency
        : (value) => intlCurrencyFormatter.format(Number(value) || 0);
    const cards = Array.isArray(budgetCards) ? budgetCards : [];
    const consumptionTotal = Number(activeBudgetConsumption || 0);
    const limitTotal = Number(activeBudgetLimit || 0);
    const usageTotal = Number.isFinite(Number(activeBudgetUsage))
        ? Number(activeBudgetUsage)
        : (limitTotal > 0 ? (consumptionTotal / limitTotal) * 100 : 0);
    const months = Array.isArray(budgetMonths) ? budgetMonths : [];
    const activeMonthKey = typeof activeBudgetMonth === 'string' && activeBudgetMonth.trim()
        ? activeBudgetMonth.trim()
        : null;
    const categories = Array.isArray(categoryConsumption) ? categoryConsumption : [];
    const editingEnabled = allowEditing === true;
    const manageLinkHref = typeof manageLink === 'string' && manageLink.trim()
        ? manageLink.trim()
        : null;
    const statusPalette = budgetStatusPalette && typeof budgetStatusPalette === 'object'
        ? budgetStatusPalette
        : {};
    const formatMonthLabel = (value) => {
        if (!value) {
            return 'Todos os meses';
        }
        const safeValue = String(value);
        const isoDate = `${safeValue}-01T00:00:00`;
        const parsed = new Date(isoDate);
        if (Number.isFinite(parsed.getTime())) {
            return parsed.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
        }
        const parts = safeValue.split('-');
        if (parts.length === 2) {
            return `${parts[1]}/${parts[0]}`;
        }
        return safeValue;
    };
    const resolveStatusStyle = (item = {}) => {
        if (item && typeof item.statusStyle === 'object' && item.statusStyle) {
            return {
                key: item.statusStyle.key || item.status || 'healthy',
                badgeClass: item.statusStyle.badgeClass || 'bg-success-subtle text-success',
                barColor: item.statusStyle.barColor || '#10b981',
                label: item.statusStyle.label || 'Consumo saudável',
                icon: item.statusStyle.icon || 'bi-emoji-smile'
            };
        }
        const statusKey = item.status || (item.statusMeta && item.statusMeta.key) || 'healthy';
        const paletteEntry = statusPalette[statusKey] || statusPalette.healthy || {};
        return {
            key: paletteEntry.key || statusKey,
            badgeClass: paletteEntry.badgeClass || 'bg-success-subtle text-success',
            barColor: paletteEntry.barColor || '#10b981',
            label: paletteEntry.label || 'Consumo saudável',
            icon: paletteEntry.icon || 'bi-emoji-smile'
        };
    };
%>
<div class="card card-soft responsive-panel" data-budget-overview>
    <div class="card-body">
        <div class="d-flex flex-column flex-xl-row justify-content-between align-items-start align-items-xl-center gap-4 mb-4">
            <div>
                <h3 class="fw-semibold mb-1">Orçamentos monitorados</h3>
                <p class="text-muted mb-0">Acompanhe limites, consumo por categoria e alertas configurados.</p>
            </div>
            <div class="d-flex flex-column flex-lg-row align-items-lg-center gap-3">
                <% if (manageLinkHref) { %>
                    <a class="btn btn-outline-primary" href="<%= manageLinkHref %>">
                        <i class="bi bi-kanban me-2" aria-hidden="true"></i>
                        Gerenciar orçamentos
                    </a>
                <% } %>
                <div class="d-flex flex-wrap gap-3 text-muted small">
                    <div>
                        <span class="d-block text-uppercase">Consumo</span>
                        <span class="fs-6 fw-semibold" data-budget-summary="consumption"><%= formatCurrencyFn(consumptionTotal) %></span>
                    </div>
                    <div>
                        <span class="d-block text-uppercase">Limite</span>
                        <span class="fs-6 fw-semibold" data-budget-summary="limit"><%= formatCurrencyFn(limitTotal) %></span>
                    </div>
                    <div>
                        <span class="d-block text-uppercase">Utilização</span>
                        <span class="fs-6 fw-semibold" data-budget-summary="usage"><%= usageTotal.toFixed(1) %>%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 align-items-stretch">
            <div class="col-12 col-xxl-8">
                <div class="d-flex flex-column gap-3">
                    <div class="d-flex flex-column flex-lg-row justify-content-between gap-3 align-items-start align-items-lg-center">
                        <div class="d-flex align-items-center gap-3">
                            <label class="text-muted small text-uppercase" for="budget-month-selector">Período</label>
                            <select
                                id="budget-month-selector"
                                class="form-select form-select-sm"
                                data-budget-month-selector
                            >
                                <option value="all" <%= activeMonthKey ? '' : 'selected' %>>Todos os meses</option>
                                <% months.forEach((monthKey) => { %>
                                    <option value="<%= monthKey %>" <%= activeMonthKey === monthKey ? 'selected' : '' %>>
                                        <%= formatMonthLabel(monthKey) %>
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                        <% if (editingEnabled) { %>
                            <span class="badge rounded-pill bg-light text-muted">
                                <i class="bi bi-pencil-square me-2" aria-hidden="true"></i>
                                Ajuste limites diretamente nos cartões
                            </span>
                        <% } %>
                    </div>

                    <div class="row g-4" data-budget-grid>
                        <% if (!cards.length) { %>
                            <div class="col-12">
                                <div class="alert alert-info border-0 shadow-sm mb-0" role="alert">
                                    <i class="bi bi-info-circle me-2" aria-hidden="true"></i>
                                    Cadastre orçamentos para visualizar indicadores por categoria.
                                </div>
                            </div>
                        <% } else { %>
                            <% cards.forEach((card, index) => { %>
                                <% const status = resolveStatusStyle(card); %>
                                <div
                                    class="col-12 col-md-6"
                                    data-budget-card
                                    data-budget-index="<%= index %>"
                                    data-budget-month="<%= card.month || '' %>"
                                    data-budget-id="<%= card.budgetId || card.id || '' %>"
                                    data-budget-category="<%= card.categoryId || '' %>"
                                >
                                    <div class="h-100 border rounded-4 p-4 shadow-sm position-relative">
                                        <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
                                            <div class="d-flex align-items-start gap-3">
                                                <span
                                                    class="rounded-circle flex-shrink-0"
                                                    style="width: 12px; height: 12px; background:<%= card.categoryColor || '#6b7280' %>;"
                                                    aria-hidden="true"
                                                ></span>
                                                <div>
                                                    <h4 class="h6 fw-semibold mb-1 text-truncate"><%= card.categoryName || 'Sem categoria' %></h4>
                                                    <span class="badge bg-light text-muted fw-normal text-uppercase small px-2 py-1">
                                                        <%= formatMonthLabel(card.month) %>
                                                    </span>
                                                </div>
                                            </div>
                                            <span
                                                class="badge <%= status.badgeClass %> d-inline-flex align-items-center gap-1"
                                                data-budget-status-badge
                                                data-status-key="<%= status.key %>"
                                            >
                                                <i class="bi <%= status.icon %>" aria-hidden="true"></i>
                                                <span data-budget-status-label><%= status.label %></span>
                                            </span>
                                        </div>
                                        <div class="mb-4">
                                            <div class="progress bg-light rounded-pill" style="height: 8px;">
                                                <div
                                                    class="progress-bar"
                                                    data-budget-progress
                                                    role="progressbar"
                                                    style="width: <%= Math.min(Number(card.usage) || 0, 130).toFixed(1) %>%; background:<%= status.barColor %>;"
                                                    aria-valuenow="<%= (Number(card.usage) || 0).toFixed(1) %>"
                                                    aria-valuemin="0"
                                                    aria-valuemax="150"
                                                ></div>
                                            </div>
                                            <div class="d-flex justify-content-between text-muted small mt-2">
                                                <span>Consumido</span>
                                                <span data-budget-field="consumption"><%= formatCurrencyFn(card.consumption || 0) %></span>
                                            </div>
                                        </div>
                                        <div class="d-flex flex-wrap gap-3 text-sm">
                                            <div>
                                                <span class="text-muted small d-block">Limite</span>
                                                <span class="fw-semibold" data-budget-field="limit"><%= formatCurrencyFn(card.monthlyLimit || 0) %></span>
                                            </div>
                                            <div>
                                                <span class="text-muted small d-block">Disponível</span>
                                                <span
                                                    class="fw-semibold <%= Number(card.remaining || 0) < 0 ? 'text-danger' : 'text-success' %>"
                                                    data-budget-field="remaining"
                                                    data-positive-class="text-success"
                                                    data-negative-class="text-danger"
                                                >
                                                    <%= formatCurrencyFn(card.remaining || 0) %>
                                                </span>
                                            </div>
                                            <div>
                                                <span class="text-muted small d-block">Utilização</span>
                                                <span class="fw-semibold" data-budget-field="usage"><%= (Number(card.usage) || 0).toFixed(1) %>%</span>
                                            </div>
                                        </div>
                                        <div class="mt-4" data-threshold-container>
                                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-2">
                                                <div>
                                                    <span class="text-muted small d-block">Alertas de consumo</span>
                                                    <span class="text-muted small">Ajuste os limites para antecipar excessos.</span>
                                                </div>
                                                <% if (editingEnabled && (card.budgetId || card.id)) { %>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" data-threshold-toggle aria-expanded="false">
                                                        <i class="bi bi-pencil-square me-1" aria-hidden="true"></i>
                                                        Ajustar limites
                                                    </button>
                                                <% } %>
                                            </div>
                                            <div class="d-flex flex-wrap gap-2 align-items-center" data-threshold-badges>
                                                <% if (!Array.isArray(card.thresholds) || !card.thresholds.length) { %>
                                                    <span class="badge bg-light text-muted" data-threshold-empty>Sem limites cadastrados</span>
                                                <% } else { %>
                                                    <% card.thresholds.forEach((threshold) => { %>
                                                        <span class="badge bg-primary-subtle text-primary-emphasis d-inline-flex align-items-center gap-2">
                                                            <i class="bi bi-flag-fill" aria-hidden="true"></i>
                                                            <span><%= formatCurrencyFn(threshold) %></span>
                                                        </span>
                                                    <% }); %>
                                                <% } %>
                                            </div>
                                            <div class="visually-hidden" data-threshold-live aria-live="polite"></div>
                                            <% if (editingEnabled && (card.budgetId || card.id)) { %>
                                                <div class="alert alert-danger d-none mt-3 mb-0 py-2 px-3" role="status" data-threshold-feedback></div>
                                                <form class="threshold-inline-form d-none mt-3" data-threshold-form novalidate>
                                                    <div class="small text-muted mb-2">Valores são comparados com o limite mensal definido para o orçamento.</div>
                                                    <div data-threshold-inputs></div>
                                                    <div class="d-flex flex-wrap gap-2 mt-3">
                                                        <button type="button" class="btn btn-outline-secondary btn-sm" data-threshold-cancel>Cancelar</button>
                                                        <button type="submit" class="btn btn-gradient btn-sm">Salvar limites</button>
                                                        <button type="button" class="btn btn-link btn-sm text-decoration-none" data-threshold-add>
                                                            <i class="bi bi-plus-circle me-1" aria-hidden="true"></i>
                                                            Adicionar limite
                                                        </button>
                                                    </div>
                                                </form>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>

                    <div class="alert d-none align-items-center gap-2" data-budget-feedback role="alert" aria-live="polite"></div>
                </div>
            </div>
            <div class="col-12 col-xxl-4">
                <div class="h-100 border rounded-4 p-4 shadow-sm bg-light-subtle">
                    <h4 class="h6 fw-semibold mb-3">Distribuição por categoria</h4>
                    <canvas id="budget-consumption-chart" height="220" class="w-100 mb-4" aria-label="Gráfico de consumo por categoria" role="img"></canvas>
                    <div class="list-group list-group-flush small" data-category-consumption-list>
                        <% if (!categories.length) { %>
                            <div class="text-muted">Nenhum consumo registrado para o período.</div>
                        <% } else { %>
                            <% categories.slice(0, 6).forEach((category) => { %>
                                <div class="list-group-item px-0 d-flex justify-content-between align-items-center gap-3">
                                    <div class="d-flex align-items-center gap-3">
                                        <span
                                            class="rounded-circle flex-shrink-0"
                                            style="width: 10px; height: 10px; background:<%= category.categoryColor || '#6b7280' %>;"
                                            aria-hidden="true"
                                        ></span>
                                        <div>
                                            <div class="fw-semibold text-truncate"><%= category.categoryName %></div>
                                            <div class="text-muted small">
                                                Média: <%= (Number(category.averagePercentage) || 0).toFixed(1) %>% · Pico: <%= (Number(category.highestPercentage) || 0).toFixed(1) %>%
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <div class="fw-semibold"><%= formatCurrencyFn(category.totalConsumption || 0) %></div>
                                        <div class="text-muted small"><%= category.months %> mês(es)</div>
                                    </div>
                                </div>
                            <% }); %>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
