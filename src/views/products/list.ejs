<%- include('../partials/header') %>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">Produtos</h1>
        <p class="text-muted mb-0">Gerencie o catálogo de produtos, preços, estoque e fornecedores.</p>
    </div>
    <div class="d-flex gap-2">
        <a href="/products/new" class="btn btn-primary">
            <i class="bi bi-plus-lg me-2"></i>Novo produto
        </a>
    </div>
</div>

<% if (success_msg) { %>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i><%= success_msg %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
<% } %>
<% if (error_msg) { %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i><%= error_msg %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    </div>
<% } %>

<%
const formatMoney = (value, currency = 'BRL') => {
    if (value === undefined || value === null || value === '') {
        return '—';
    }
    try {
        return new Intl.NumberFormat('pt-BR', { style: 'currency', currency }).format(Number(value));
    } catch (error) {
        return Number(value).toFixed(2);
    }
};

const currentFilters = (typeof filters === 'object' && filters) ? filters : {};
const brandOptions = (availableFilters && Array.isArray(availableFilters.brands)) ? availableFilters.brands : [];
const typeOptions = (availableFilters && Array.isArray(availableFilters.types)) ? availableFilters.types : [];
const sortOptionsList = Array.isArray(sortOptions) && sortOptions.length ? sortOptions : [
    { value: 'created-desc', label: 'Mais recentes' },
    { value: 'price-asc', label: 'Menor preço → Maior preço' },
    { value: 'price-desc', label: 'Maior preço → Menor preço' },
    { value: 'name-asc', label: 'Nome (A → Z)' },
    { value: 'name-desc', label: 'Nome (Z → A)' }
];
const activeBadges = [];
if (currentFilters.description) {
    activeBadges.push({ label: 'Descrição', value: currentFilters.description });
}
if (currentFilters.brand) {
    activeBadges.push({ label: 'Marca', value: currentFilters.brand });
}
if (currentFilters.type) {
    activeBadges.push({ label: 'Categoria', value: currentFilters.type });
}
if (currentFilters.sort && currentFilters.sort !== 'created-desc') {
    const activeSort = sortOptionsList.find((option) => option.value === currentFilters.sort);
    if (activeSort) {
        activeBadges.push({ label: 'Ordenação', value: activeSort.label });
    }
}
%>

<div class="card shadow-sm border-0">
    <div class="card-body border-bottom bg-light-subtle">
        <form class="row g-3 g-md-4 align-items-end" method="GET">
            <div class="col-12 col-md-6 col-lg-4">
                <label for="description" class="form-label small text-uppercase text-muted">Descrição</label>
                <input type="text" class="form-control" id="description" name="description" placeholder="Buscar termos da descrição" value="<%= currentFilters.description || '' %>" autocomplete="off">
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <label for="brand" class="form-label small text-uppercase text-muted">Marca</label>
                <input type="text" class="form-control" id="brand" name="brand" placeholder="Todas" value="<%= currentFilters.brand || '' %>" list="brand-options" autocomplete="off">
                <datalist id="brand-options">
                    <% brandOptions.forEach((brand) => { %>
                        <option value="<%= brand %>"></option>
                    <% }) %>
                </datalist>
            </div>
            <div class="col-12 col-sm-6 col-lg-3">
                <label for="type" class="form-label small text-uppercase text-muted">Tipo de produto</label>
                <input type="text" class="form-control" id="type" name="type" placeholder="Todas" value="<%= currentFilters.type || '' %>" list="type-options" autocomplete="off">
                <datalist id="type-options">
                    <% typeOptions.forEach((type) => { %>
                        <option value="<%= type %>"></option>
                    <% }) %>
                </datalist>
            </div>
            <div class="col-12 col-lg-2">
                <label for="sort" class="form-label small text-uppercase text-muted">Ordenar por</label>
                <select class="form-select" id="sort" name="sort">
                    <% sortOptionsList.forEach((option) => { %>
                        <option value="<%= option.value %>" <%= (currentFilters.sort || 'created-desc') === option.value ? 'selected' : '' %>><%= option.label %></option>
                    <% }) %>
                </select>
            </div>
            <div class="col-12 col-lg-12 d-flex gap-2 justify-content-end">
                <a href="/products" class="btn btn-outline-secondary">Limpar filtros</a>
                <button type="submit" class="btn btn-primary"><i class="bi bi-funnel me-2"></i>Aplicar</button>
            </div>
        </form>
        <% if (activeBadges.length) { %>
            <div class="mt-3">
                <span class="text-muted small me-2">Filtros ativos:</span>
                <% activeBadges.forEach((badge) => { %>
                    <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis me-2 mb-1"><%= badge.label %>: <%= badge.value %></span>
                <% }) %>
            </div>
        <% } %>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="ps-4">Produto</th>
                        <th>SKU</th>
                        <th>Status</th>
                        <th>Estoque</th>
                        <th>Preço</th>
                        <th>Atualizado</th>
                        <th class="text-end pe-4">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (!products.length) { %>
                        <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                                <div class="mb-2">Nenhum produto encontrado para os filtros selecionados.</div>
                                <a href="/products" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>Limpar filtros
                                </a>
                            </td>
                        </tr>
                    <% } %>
                    <% products.forEach((product) => { %>
                        <tr>
                            <td class="ps-4">
                                <div class="fw-semibold"><%= product.name %></div>
                                <small class="text-muted"><%= product.brand || 'Marca não informada' %></small>
                            </td>
                            <td><%= product.sku || '—' %></td>
                            <td>
                                <% const statusClass = {
                                    'draft': 'badge bg-secondary',
                                    'active': 'badge bg-success',
                                    'inactive': 'badge bg-warning text-dark',
                                    'archived': 'badge bg-dark'
                                }[product.status] || 'badge bg-secondary'; %>
                                <span class="<%= statusClass %>">
                                    <%= {
                                        draft: 'Rascunho',
                                        active: 'Ativo',
                                        inactive: 'Inativo',
                                        archived: 'Arquivado'
                                    }[product.status] || product.status %>
                                </span>
                            </td>
                            <td>
                                <span class="fw-semibold"><%= product.stockQuantity ?? 0 %></span>
                                <small class="text-muted d-block"><%= {
                                    'in-stock': 'Em estoque',
                                    'out-of-stock': 'Sem estoque',
                                    'preorder': 'Pré-venda',
                                    'backorder': 'Sob encomenda'
                                }[product.stockStatus] || '—' %></small>
                            </td>
                            <td><%= formatMoney(product.price, product.currency || 'BRL') %></td>
                            <td>
                                <% const updatedAt = product.updatedAt ? new Date(product.updatedAt) : null; %>
                                <%= updatedAt ? updatedAt.toLocaleDateString('pt-BR', { year: 'numeric', month: 'short', day: 'numeric' }) : '—' %>
                            </td>
                            <td class="text-end pe-4">
                                <div class="btn-group" role="group">
                                    <a href="/products/<%= product.id %>" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-eye"></i>
                                    </a>
                                    <a href="/products/<%= product.id %>/edit" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-pencil"></i>
                                    </a>
                                    <form action="/products/<%= product.id %>?_method=DELETE" method="POST" class="d-inline-block ms-1" onsubmit="return confirm('Confirma a exclusão deste produto? Essa ação não pode ser desfeita.');">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<%- include('../partials/footer') %>
